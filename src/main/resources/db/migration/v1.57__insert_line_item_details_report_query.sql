INSERT INTO `reports_details` ( `report_name`, `created_by`, `created_date`, `modified_by`, `modified_date`) VALUES ('LINE ITEM DETAILS REPORT', 'admin', NOW(), 'admin',NOW());

INSERT INTO `reports_query_details` (`report_id`) SELECT report_id from reports_details where report_name = 'LINE ITEM DETAILS REPORT';

update `reports_query_details` set `query_detail`='SELECT po.id AS po_id , li.id AS li_id , lic.id AS lic_id , d.id AS d_id , a.id AS a_id , p.id AS p_id , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' ) AS p3_order_id , po.client_order_id , DATE(po.order_date) AS order_date , ( SELECT created_by FROM ${schema}.note WHERE note = ''Order status changed to: Order approved'' AND order_id = po.id ) AS mpt_approver , ( SELECT DATE(created_date) FROM ${schema}.note WHERE note = ''Order status changed to: Order approved'' AND order_id = po.id ) AS mpt_approved_date , DATE(po.order_need_by_date) AS order_need_by_date , ( SELECT DATE(value) FROM ${schema}.order_property WHERE order_id = po.id AND name = ''oeStartDate'' ) AS oe_start_date , ( SELECT DATE(value) FROM ${schema}.order_property WHERE order_id = po.id AND name = ''oeEndDate'' ) AS oe_end_date , ( SELECT DATE(value) FROM ${schema}.order_property WHERE order_id = po.id AND name = ''eventDate'' ) AS event_date , ( SELECT DATE(modified_date) FROM ${schema}.order_status WHERE order_id = po.id AND status LIKE ''%SHIPPED%'' GROUP BY order_id ) AS complete_ship_date , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''eventType'' ) AS event_type , ( SELECT segment FROM EnI.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS segment , ( SELECT plans_and_products FROM EnI.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS Plans_And_Products , ( SELECT no_of_employees FROM EnI.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS number_of_employees , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''userName'' ) AS purchaser , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''userEmail'' ) AS purchaser_email , li.customer_product_id , ( SELECT value FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''productName'' ) AS product_name , lic.customer_sku AS sku , ( SELECT customer_name FROM EnI.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS customer_name , d.organization_name AS ship_to_company_name , p.first_name , p.last_name , a.address1 , a.address2 , a.city , a.state , ( CASE WHEN a.zip_code IS NULL THEN LEFT(a.postal_code, 5) ELSE a.zip_code END ) AS zip_code , li.ship_method , ( SELECT TRIM(message) FROM ${schema}.tracking_status WHERE LEFT(TRIM(message), 2) = ''1Z'' AND destination_id = d.id GROUP BY destination_id ) AS tracking_number , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''selectedPrintBuyer'' ) AS print_procurement_team , SUBSTRING_INDEX(SUBSTRING_INDEX(( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''artworkFileLocation''), ''/'', 6), ''/'', - 1) AS print_vendor , ( SELECT status FROM ${schema}.line_item_status WHERE id = li.line_item_status_id ) AS line_item_status , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''GLCode'' ) AS gl_code , ( SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityShipped'' ) AS quantity_shipped , ( CASE WHEN ( SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'' ) IS NULL THEN li.quantity ELSE ( SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'') END ) AS quantity_ordered , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''totalAmount'' ) - ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''taxAmount'') AS product_amount , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''taxAmount'' ) AS tax_amount , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''totalAmount'' ) AS total_amount FROM ${schema}.platform_order po JOIN ${schema}.line_item li ON po.id = li.order_id JOIN ${schema}.line_item_component lic ON li.id = lic.line_item_id JOIN ${schema}.destination d ON li.id = d.line_item_id JOIN ${schema}.address a ON d.address_id = a.id JOIN ${schema}.person p ON p.id = d.person_id WHERE po.program_id = 3 AND DATE(po.order_date) >= STR_TO_DATE(:startDate, ''%Y-%m-%d'') AND DATE(po.order_date) <= STR_TO_DATE(:endDate, ''%Y-%m-%d'')' , `datasource` = '${schema}', `created_date` = NOW(), `modified_date` = NOW()
where report_id = (SELECT report_id from reports_details where report_name = 'LINE ITEM DETAILS REPORT')
