INSERT INTO `reports_details` ( `report_name`, `created_by`, `created_date`, `modified_by`, `modified_date`) VALUES ('ORDER DETAILS REPORT', 'admin', NOW(), 'admin',NOW());

INSERT INTO `reports_query_details` (`report_id`) SELECT report_id from reports_details where report_name = 'ORDER DETAILS REPORT';

update `reports_query_details` set `query_detail`='SELECT po.id AS po_id, po.client_order_id, DATE(po.order_date) AS order_date, DATE(po.order_need_by_date) AS order_need_by_date, li.id AS li_id, li.ship_method, li.customer_product_id, lic.id AS lic_id, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''p3OrderId'' ) AS p3_order_id, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''p3Segment'' ) AS segment, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''plansAndProducts'' ) AS Plans_And_Products, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''numberEmployees'' ) AS number_of_employees, ( SELECT created_by FROM EnI.note WHERE note = ''Order status changed to: Order approved'' AND order_id = po.id ) AS mpt_approver, ( SELECT DATE(created_date) FROM EnI.note WHERE note = ''Order status changed to: Order approved'' AND order_id = po.id ) AS mpt_approved_date, ( SELECT DATE(value) FROM EnI.order_property WHERE order_id = po.id AND name = ''oeStartDate'' ) AS oe_start_date, ( SELECT DATE(value) FROM EnI.order_property WHERE order_id = po.id AND name = ''oeEndDate'' ) AS oe_end_date, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''eventType'' ) AS event_type, ( SELECT DATE(value) FROM EnI.order_property WHERE order_id = po.id AND name = ''eventDate'' ) AS event_date, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''userName'' ) AS customer_name, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''userEmail'' ) AS user_email, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''selectedPrintBuyer'' ) AS print_procurement_team, SUBSTRING_INDEX(SUBSTRING_INDEX(( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''artworkFileLocation''), '' / '', 6), '' / '', - 1) AS print_vendor, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''taxAmount'' ) AS tax_amount, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''totalAmount'' ) AS total_amount, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''totalAmount'' ) - ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''taxAmount'') AS product_amount, ( SELECT value FROM EnI.order_property WHERE order_id = po.id AND name = ''GLCode'' ) AS gl_code, ( SELECT value FROM EnI.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''productName'' ) AS product_name, ( SELECT value FROM EnI.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''skuDescription'' ) AS sku_description, ( SELECT value FROM EnI.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''sku'' ) AS sku, ( SELECT DATE(modified_date) FROM EnI.order_status WHERE order_id = po.id AND status LIKE '' % SHIPPED % '' GROUP BY order_id ) AS complete_ship_date, d.id AS d_id, d.organization_name AS ship_to_company_name, p.id AS p_id, p.first_name, p.last_name, a.id AS a_id, a.address1, a.address2, a.address3, a.city, a.state, ( CASE WHEN a.zip_code IS NULL THEN LEFT(a.postal_code, 5) ELSE a.zip_code END ) AS zip_code , ( SELECT status FROM EnI.order_status WHERE id = po.order_status_id ) AS order_status, ( SELECT status FROM EnI.line_item_status WHERE id = li.line_item_status_id ) AS line_item_status, ( SELECT TRIM(message) FROM EnI.tracking_status WHERE LEFT(TRIM(message), 2) = ''1Z'' AND destination_id = d.id GROUP BY destination_id ) AS tracking_number, ( SELECT value FROM EnI.destination_property WHERE destination_id = d.id AND name = ''quantityShipped'' ) AS quantity_shipped, ( CASE WHEN ( SELECT value FROM EnI.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'' ) IS NULL THEN li.quantity ELSE ( SELECT value FROM EnI.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'') END ) AS quantity_ordered FROM EnI.platform_order po JOIN EnI.line_item li ON po.id = li.order_id JOIN EnI.line_item_component lic ON li.id = lic.line_item_id JOIN EnI.destination d ON li.id = d.line_item_id JOIN EnI.address a ON d.address_id = a.id JOIN EnI.person p ON p.id = d.person_id WHERE po.program_id = 3 AND DATE(po.order_date) >= STR_TO_DATE(:startDate, ''%Y-%m-%d'') AND DATE(po.order_date) <= STR_TO_DATE(:endDate, ''%Y-%m-%d'')' , `datasource` = 'eni', `created_date` = NOW(), `modified_date` = NOW()
where report_id = (SELECT report_id from reports_details where report_name = 'ORDER DETAILS REPORT')
