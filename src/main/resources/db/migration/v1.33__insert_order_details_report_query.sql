INSERT INTO `reports_details` ( `report_name`, `created_by`, `created_date`, `modified_by`, `modified_date`) VALUES ('ORDER DETAILS REPORT', 'admin', NOW(), 'admin',NOW());

INSERT INTO `reports_query_details` (`report_id`) SELECT report_id from reports_details where report_name = 'ORDER DETAILS REPORT';

update `reports_query_details` set `query_detail`='SELECT po.id AS po_id , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' ) AS p3_order_id , po.client_order_id , DATE(po.order_date) AS order_date , ( SELECT created_by FROM ${schema}.note WHERE note = ''Order status changed to: Order approved'' AND order_id = po.id ) AS mpt_approver , ( SELECT DATE(created_date) FROM ${schema}.note WHERE note = ''Order status changed to: Order approved'' AND order_id = po.id ) AS mpt_approved_date , DATE(po.order_need_by_date) AS order_need_by_date , ( SELECT DATE(value) FROM ${schema}.order_property WHERE order_id = po.id AND name = ''oeStartDate'' ) AS oe_start_date , ( SELECT DATE(value) FROM ${schema}.order_property WHERE order_id = po.id AND name = ''oeEndDate'' ) AS oe_end_date , ( SELECT DATE(value) FROM ${schema}.order_property WHERE order_id = po.id AND name = ''eventDate'' ) AS event_date , ( SELECT DATE(modified_date) FROM ${schema}.order_status WHERE order_id = po.id AND status LIKE ''%SHIPPED%'' GROUP BY order_id ) AS complete_ship_date , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''eventType'' ) AS event_type , ( SELECT segment FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS segment , ( SELECT plans_and_products FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS Plans_And_Products , ( SELECT no_of_employees FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS number_of_employees , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''userName'' ) AS purchaser , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''userEmail'' ) AS purchaser_email , ( SELECT customer_name FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS customer_name , d.organization_name AS ship_to_company_name , ( SELECT ship_to_first_name FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS first_name , ( SELECT ship_to_last_name FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS last_name , ( SELECT street_address_1 FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS address1 , ( SELECT street_address_2 FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS address2 , ( SELECT city FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS city , ( SELECT state FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS state , ( SELECT zip_code FROM eni.p3_order_detail WHERE p3_order_id = ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'' )) AS zip_code , li.ship_method , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''selectedPrintBuyer'' ) AS print_procurement_team , SUBSTRING_INDEX(SUBSTRING_INDEX(( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''artworkFileLocation''), ''/'', 6), ''/'', - 1) AS print_vendor , ( SELECT status FROM ${schema}.order_status WHERE id = po.order_status_id ) AS order_status , ( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''GLCode'' ) AS gl_code , SUM(( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''totalAmount'' )) - SUM(( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''taxAmount'')) AS product_amount , SUM(( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''taxAmount'' )) AS tax_amount , SUM(( SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''totalAmount'' )) AS total_amount FROM ${schema}.platform_order po JOIN ${schema}.line_item li ON po.id = li.order_id JOIN ${schema}.destination d ON li.id = d.line_item_id WHERE po.program_id = 3 AND DATE(po.order_date) >= STR_TO_DATE(:startDate, ''%Y-%m-%d'') AND DATE(po.order_date) <= STR_TO_DATE(:endDate, ''%Y-%m-%d'') GROUP BY po.id' , `datasource` = '${schema}', `created_date` = NOW(), `modified_date` = NOW()
where report_id = (SELECT report_id from reports_details where report_name = 'ORDER DETAILS REPORT')
