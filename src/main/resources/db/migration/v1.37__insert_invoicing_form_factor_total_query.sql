update `reports_query_details` set `query_detail`='SELECT ( CASE WHEN esi.size is NULL THEN '''' ELSE esi.size END ) as size ,CAST((CASE WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) IS NULL THEN '''' WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 8 THEN ''Loose'' WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 48 THEN ''Saddle Stitch'' ELSE ''Perfect'' END) AS CHAR(50)) AS finish ,SUM(a.quantityOrdered) AS quantity_ordered FROM ( SELECT lic.customer_sku ,lic.page_count AS lic_page_count ,(SELECT CAST(value AS UNSIGNED) FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''pageCount'') AS liccp_page_count ,(SELECT value FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''productName'') AS productName ,(CASE WHEN (SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'') IS NULL THEN lic.quantity ELSE (SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'') END) AS quantityOrdered FROM ${schema}.platform_order po JOIN ${schema}.line_item li ON po.id = li.order_id JOIN ${schema}.line_item_component lic ON li.id = lic.line_item_id JOIN ${schema}.destination d ON li.id = d.line_item_id WHERE po.program_id = 3 AND SUBSTRING_INDEX(SUBSTRING_INDEX((SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''artworkFileLocation''),''/'',6),''/'',-1) != ''RR-DO-11'' AND ( (SELECT DATE(modified_date) FROM ${schema}.line_item_status WHERE line_item_id = li.id AND status LIKE ''%SHIPPED%'' GROUP BY line_item_id) >= STR_TO_DATE(:startDate, ''%Y-%m-%d'') AND (SELECT DATE(modified_date) FROM ${schema}.line_item_status WHERE line_item_id = li.id AND status LIKE ''%SHIPPED%'' GROUP BY line_item_id) <= STR_TO_DATE(:endDate, ''%Y-%m-%d'') OR ((SELECT status FROM ${schema}.line_item_status WHERE id = li.line_item_status_id) NOT LIKE ''%SHIPPED%'' AND po.order_need_by_date >= DATE_ADD(STR_TO_DATE(:startDate, ''%Y-%m-%d''), INTERVAL -1 MONTH) AND LEFT((SELECT TRIM(message) FROM ${schema}.tracking_status WHERE LEFT(TRIM(message),2) = ''1Z'' AND destination_id = d.id GROUP BY destination_id),2) = ''1Z'') ) AND ( LOCATE(''toolkit'',LOWER(customer_product_id)) > 0 OR ( LOCATE(''kit'',LOWER(customer_product_id)) = 0 AND LOCATE(''packet'',LOWER(customer_product_id)) = 0 AND customer_product_id != ''PA and DE Traditional'' ) ) ) a LEFT JOIN eni.sku_item esi ON esi.item_number = a.customer_sku GROUP BY ( CASE WHEN esi.size is NULL THEN '''' ELSE esi.size END ) ,CAST((CASE WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) IS NULL THEN '''' WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 8 THEN ''Loose'' WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 48 THEN ''Saddle Stitch'' ELSE ''Perfect'' END) AS CHAR(50))' , `datasource` = '${schema}', `created_date` = NOW(), `modified_date` = NOW()
where report_id = (SELECT report_id from reports_details where report_name = 'INVOICING FORM FACTOR TOTAL REPORT')
