update `reports_query_details` set `query_detail`='SELECT REPLACE((CASE WHEN LEFT(b.funding_type,5) = ''https'' THEN REPLACE(SUBSTRING_INDEX(b.funding_type,''/'',-1),''.jpg'','''') ELSE SUBSTRING_INDEX(b.funding_type,''_'',-1) END),''%20'',''_'') AS funding_type ,COUNT(DISTINCT b.po_id) AS orders_count ,b.order_date ,SUM(b.quantity) AS quantity FROM ( SELECT (SELECT value FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND name IN (''TEMPLATEFunding_Type'',''TEMPLATEFunding_Method'',''TEMPLATE_Funding_Type'',''TEMPLATE_Funding_Method'')) AS funding_type ,po.id AS po_id, DATE(po.order_date) as order_date ,lic.quantity FROM ${schema}.platform_order po JOIN ${schema}.line_item li ON po.id = li.order_id JOIN ${schema}.line_item_component lic ON li.id = lic.line_item_id WHERE po.program_id = 3 AND (SELECT LOWER(value) FROM sbs_platform_order.line_item_component_custom_property WHERE line_item_component_id = lic.id AND name = ''productName'') LIKE ''%welcome%'' AND (SELECT LOWER(value) FROM sbs_platform_order.line_item_component_custom_property WHERE line_item_component_id = lic.id AND name = ''productName'') LIKE ''%Configurable%'' AND (SELECT status FROM ${schema}.order_status WHERE id = po.order_status_id) IN (''ORDER_APPROVED'',''FAILED_SENT_TO_PRINTER'',''IN_PROCESS'',''SENT_TO_PRINTER'',''SHIPPED'') ) b GROUP BY b.order_date, REPLACE((CASE WHEN LEFT(b.funding_type,5) = ''https'' THEN REPLACE(SUBSTRING_INDEX(b.funding_type,''/'',-1),''.jpg'','''') ELSE SUBSTRING_INDEX(b.funding_type,''_'',-1) END),''%20'',''_'')' , `datasource` = '${schema}', `created_date` = NOW(), `modified_date` = NOW()
where report_id = (SELECT report_id from reports_details where report_name = 'ONBOARDING DASHBOARD WCB BY FUNDING TYPE REPORT')
