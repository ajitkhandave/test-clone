INSERT INTO `reports_details` ( `report_name`, `created_by`, `created_date`, `modified_by`, `modified_date`) VALUES ('INVOICING ORDER LEVEL SHIPPED REPORT', 'admin', NOW(), 'admin',NOW());

INSERT INTO `reports_query_details` (`report_id`) SELECT report_id from reports_details where report_name = 'INVOICING ORDER LEVEL SHIPPED REPORT';

update `reports_query_details` set `query_detail`='SELECT c.p3OrderId as p3_order_id ,c.client_order_id ,c.p3Segment as p3_segment ,c.oeStartDate as oe_start_date ,c.oeEndDate as oe_end_date ,c.order_date,c.order_need_by_date ,c.complete_ship_date ,c.ship_to_company_name AS customer_name ,c.print_vendor ,c.order_status ,c.GLCode as gl_code ,SUM(c.quantityOrdered) AS quantity_ordered ,SUM(c.productPrice) AS product_price ,SUM(c.kitting_price) AS kitting_price ,SUM(c.label_and_carton_price) AS label_and_carton_price ,SUM(c.staple_price) AS staple_price ,(SUM(c.productPrice) + SUM(c.kitting_price) + SUM(c.label_and_carton_price) + SUM(c.staple_price)) * .07525 AS tax_amount ,(SUM(c.productPrice) + SUM(c.kitting_price) + SUM(c.label_and_carton_price) + SUM(c.staple_price)) * 1.07525 AS total_amount FROM ( SELECT b.* ,(CASE WHEN LOCATE(''Shutterfly-MA'',b.print_vendor) > 0 THEN IFNULL(ep.dl_config_price,0) WHEN LOCATE(''Shutterfly'',b.print_vendor) > 0 THEN IFNULL(ep.sfly_config_price,0) WHEN LOCATE(''DigitalLizard'',b.print_vendor) > 0 THEN IFNULL(ep.dl_config_price,0) WHEN LOCATE(''ONETOUCHPOINT'',b.print_vendor) > 0 THEN IFNULL(ep.otp_config_price,0) WHEN LOCATE(''Streamworks'',b.print_vendor) > 0 THEN IFNULL(ep.sw_config_price,0) ELSE 0 END) * b.quantityOrdered AS productPrice ,(CASE WHEN LOCATE(''toolkit'',LOWER(b.customer_product_id)) = 0 AND (LOCATE(''kit'',LOWER(b.customer_product_id)) > 0 OR LOCATE(''packet'',LOWER(b.customer_product_id)) > 0 OR b.customer_product_id = ''PA and DE Traditional'') THEN ( (CASE WHEN LOCATE(''business reply envelope'',LOWER(b.customer_product_id)) > 0 THEN b.quantityOrdered WHEN (LOCATE(''envelope'',LOWER(b.customer_product_id)) > 0 OR LOCATE(''folder'',LOWER(b.customer_product_id)) > 0) THEN 0 ELSE b.quantityOrdered END) ) * .9 ELSE 0 END) AS kitting_price ,((CASE WHEN LOCATE(''Shutterfly-MA'',b.print_vendor) > 0 THEN .05 WHEN LOCATE(''Shutterfly'',b.print_vendor) > 0 THEN .03 WHEN LOCATE(''DigitalLizard'',b.print_vendor) > 0 THEN .05 WHEN LOCATE(''ONETOUCHPOINT'',b.print_vendor) > 0 THEN .15 WHEN LOCATE(''Streamworks'',b.print_vendor) > 0 THEN .15 ELSE 0 END) + .35) * b.order_rank AS label_and_carton_price ,(CASE WHEN b.pageCount > 2 AND b.pageCount < 8 AND b.size = ''8.5 x 11'' THEN .03 ELSE 0 END) * b.quantityOrdered AS staple_price FROM ( SELECT a.* ,(CASE WHEN esi.is_static = 1 THEN pod.gl_code ELSE pod.gl_code_other END) AS GLCode ,esi.is_static ,esi.size ,esi.black_or_color AS black_color ,CAST((CASE WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) IS NULL THEN NULL WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 8 THEN ''Loose'' WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 48 THEN ''Saddle Stitch'' ELSE ''Perfect'' END) AS CHAR(50)) AS finish ,(CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) AS pageCount ,(CASE WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 8 THEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) WHEN (CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END) < 48 THEN CEILING((CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END)/4)*4 ELSE CEILING((CASE WHEN esi.is_static = 1 THEN esi.page_count ELSE (CASE WHEN a.lic_page_count = 0 THEN IFNULL(a.liccp_page_count,0) ELSE a.lic_page_count END) END)/8)*8 END) AS page_count_config_join FROM ( SELECT po.id AS po_id ,po.client_order_id ,DATE(po.order_date) AS order_date ,DATE(po.order_need_by_date) AS order_need_by_date ,li.id AS li_id ,li.customer_product_id ,lic.id AS lic_id ,lic.customer_sku ,lic.page_count AS lic_page_count ,(SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'') AS ''p3OrderId'' ,SUBSTRING_INDEX(SUBSTRING_INDEX((SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''artworkFileLocation''),''/'',6),''/'',-1) AS print_vendor ,(SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''oeStartDate'') AS oeStartDate ,(SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''oeEndDate'') AS oeEndDate ,(SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3Segment'') AS p3Segment ,(SELECT value FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''productName'') AS productName ,(SELECT value FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''skuDescription'') AS sku_description ,(SELECT value FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''sku'') AS sku ,(SELECT CAST(value AS UNSIGNED) FROM ${schema}.line_item_component_custom_property WHERE line_item_component_id = lic.id AND NAME = ''pageCount'') AS liccp_page_count ,(SELECT DATE(modified_date) FROM ${schema}.order_status WHERE order_id = po.id AND status LIKE ''%SHIPPED%'' GROUP BY order_id) AS complete_ship_date ,d.id AS d_id ,(SELECT status FROM ${schema}.order_status WHERE id = po.order_status_id) AS order_status ,(SELECT status FROM ${schema}.line_item_status WHERE id = li.line_item_status_id) AS line_item_status ,(SELECT TRIM(message) FROM ${schema}.tracking_status WHERE LEFT(TRIM(message),2) = ''1Z'' AND destination_id = d.id GROUP BY destination_id) AS tracking_number ,(SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityShipped'') AS quantityShipped ,(CASE WHEN (SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'') IS NULL THEN lic.quantity ELSE (SELECT value FROM ${schema}.destination_property WHERE destination_id = d.id AND name = ''quantityOrdered'') END) AS quantityOrdered ,(CASE WHEN ra.order_rank = 1 THEN 1 ELSE 0 END) AS order_rank ,d.organization_name AS ship_to_company_name FROM ${schema}.platform_order po JOIN ${schema}.line_item li ON po.id = li.order_id JOIN ${schema}.line_item_component lic ON li.id = lic.line_item_id JOIN ${schema}.destination d ON li.id = d.line_item_id LEFT JOIN ( SELECT b.* ,@order_kit2\\:=b.po_id AS order_kit2 ,@rank2\\:=if(@prev_order_number2 != @order_kit2, 1, @rank2 + 1) AS order_rank ,@prev_order_number2\\:=@order_kit2 as dummy FROM ( SELECT po.id AS po_id ,li.id AS li_id ,lic.id AS lic_id ,d.id AS d_id ,(SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''p3OrderId'') AS ''p3OrderId'' ,po.client_order_id ,li.customer_product_id FROM ${schema}.platform_order po JOIN ${schema}.line_item li ON po.id = li.order_id JOIN ${schema}.line_item_component lic ON li.id = lic.line_item_id JOIN ${schema}.destination d ON li.id = d.line_item_id WHERE po.program_id = 3 AND SUBSTRING_INDEX(SUBSTRING_INDEX((SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''artworkFileLocation''),''/'',6),''/'',-1) != ''RR-DO-11'' AND ( (SELECT DATE(modified_date) FROM ${schema}.line_item_status WHERE line_item_id = li.id AND status LIKE ''%SHIPPED%'' GROUP BY line_item_id) >= STR_TO_DATE(:startDate, ''%Y-%m-%d'') AND (SELECT DATE(modified_date) FROM ${schema}.line_item_status WHERE line_item_id = li.id AND status LIKE ''%SHIPPED%'' GROUP BY line_item_id) <= STR_TO_DATE(:endDate, ''%Y-%m-%d'') OR ((SELECT status FROM ${schema}.line_item_status WHERE id = li.line_item_status_id) NOT LIKE ''%SHIPPED%'' AND po.order_need_by_date >= DATE_ADD(STR_TO_DATE(:startDate, ''%Y-%m-%d''), INTERVAL -1 MONTH) AND LEFT((SELECT TRIM(message) FROM ${schema}.tracking_status WHERE LEFT(TRIM(message),2) = ''1Z'' AND destination_id = d.id GROUP BY destination_id),2) = ''1Z'') ) ) b, (SELECT @rank2\\:=0) r, (SELECT @prev_order_number2\\:='''') p ) ra ON ra.po_id = po.id AND ra.li_id = li.id AND ra.lic_id = lic.id AND ra.d_id = d.id WHERE po.program_id = 3 AND SUBSTRING_INDEX(SUBSTRING_INDEX((SELECT value FROM ${schema}.order_property WHERE order_id = po.id AND name = ''artworkFileLocation''),''/'',6),''/'',-1) != ''RR-DO-11'' AND ( (SELECT DATE(modified_date) FROM ${schema}.line_item_status WHERE line_item_id = li.id AND status LIKE ''%SHIPPED%'' GROUP BY line_item_id) >= STR_TO_DATE(:startDate, ''%Y-%m-%d'') AND (SELECT DATE(modified_date) FROM ${schema}.line_item_status WHERE line_item_id = li.id AND status LIKE ''%SHIPPED%'' GROUP BY line_item_id) <= STR_TO_DATE(:endDate, ''%Y-%m-%d'') OR ((SELECT status FROM ${schema}.line_item_status WHERE id = li.line_item_status_id) NOT LIKE ''%SHIPPED%'' AND po.order_need_by_date >= DATE_ADD(STR_TO_DATE(:startDate, ''%Y-%m-%d''), INTERVAL -1 MONTH) AND LEFT((SELECT TRIM(message) FROM ${schema}.tracking_status WHERE LEFT(TRIM(message),2) = ''1Z'' AND destination_id = d.id GROUP BY destination_id),2) = ''1Z'') ) ) a LEFT JOIN eni.sku_item esi ON esi.item_number = a.customer_sku LEFT JOIN eni.p3_order_detail pod ON pod.p3_order_id = a.p3OrderId ) b LEFT JOIN ${schema}.eni_pricing ep ON ep.size = b.size AND ep.finish = b.finish AND ep.page_count = b.page_count_config_join AND ep.black_color = b.black_color ) c GROUP BY c.po_id' , `datasource` = '${schema}', `created_date` = NOW(), `modified_date` = NOW()
where report_id = (SELECT report_id from reports_details where report_name = 'INVOICING ORDER LEVEL SHIPPED REPORT')
